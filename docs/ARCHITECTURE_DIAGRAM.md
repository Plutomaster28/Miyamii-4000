# Miyamii-4000 Architecture Diagram

## Block Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MIYAMII-4000 PROCESSOR                               │
│                            (Top Module)                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐                                    ┌──────────────┐       │
│  │   Clock &    │  clk, rst_n                        │  Control FSM │       │
│  │   Reset      │  phi1, phi2  ───────────────────>  │  (8 states)  │       │
│  └──────────────┘                                    │  A1-A2-A3    │       │
│                                                       │  M1-M2       │       │
│  ┌──────────────────────────────────┐               │  X1-X2-X3    │       │
│  │     Program Counter (12-bit)     │               └──────┬───────┘       │
│  │  ┌────────────────────────────┐  │                      │               │
│  │  │   PC Register (12-bit)     │  │                      │ control       │
│  │  └────────────┬───────────────┘  │                      │ signals       │
│  │               │                   │                      │               │
│  │  ┌────────────▼───────────────┐  │                      ▼               │
│  │  │   3-Level Stack            │  │          ┌─────────────────────┐     │
│  │  │   [SP0] [SP1] [SP2]        │  │          │  Instruction        │     │
│  │  └────────────────────────────┘  │          │  Decoder            │     │
│  └──────────┬───────────────────────┘          │                     │     │
│             │ rom_addr[11:0]                   │  • Opcode decode    │     │
│             │                                   │  • Control gen      │     │
│             ▼                                   │  • Operand extract  │     │
│  ┌──────────────────────────────────┐         └──────┬──────────────┘     │
│  │   ROM (Program Memory)           │                │                     │
│  │   4096 x 8-bit                   │                │ alu_op, reg_addr    │
│  │                                   │                │ acc_we, carry_we    │
│  │   [Instruction Bytes]            │                │                     │
│  └──────────┬───────────────────────┘                ▼                     │
│             │ rom_data[7:0]                                                 │
│             │                                                               │
│             ▼                                                               │
│  ┌──────────────────────────────────┐                                      │
│  │   Instruction Register (8-bit)   │                                      │
│  │   [First Byte | Second Byte]     │                                      │
│  └──────────┬───────────────────────┘                                      │
│             │                                                               │
│             │                                                               │
│  ┌──────────▼───────────────────────────────────────────────────┐         │
│  │                    DATA PATH                                  │         │
│  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │         │
│  │  │ Accumulator  │    │  Carry Flag  │    │   ALU        │   │         │
│  │  │   (4-bit)    │───>│   (1-bit)    │───>│   (4-bit)    │   │         │
│  │  │              │    │              │    │              │   │         │
│  │  │     ACC      │    │      CY      │    │  • ADD/SUB   │   │         │
│  │  └──────┬───────┘    └──────────────┘    │  • INC/DEC   │   │         │
│  │         │                     ▲           │  • AND/OR    │   │         │
│  │         │                     │           │  • CMA       │   │         │
│  │         │        ┌────────────┘           │  • RAL/RAR   │   │         │
│  │         │        │                        │  • TCC/TCS   │   │         │
│  │         │        │                        │  • DAA/KBP   │   │         │
│  │         ▼        │                        └──────┬───────┘   │         │
│  │    ┌────────────────────────────────┐           │           │         │
│  │    │   Register File                │           │           │         │
│  │    │   16 x 4-bit registers         │           │           │         │
│  │    │                                 │           │           │         │
│  │    │   R0  R1  R2  R3  R4  R5  R6  R7│          │           │         │
│  │    │   R8  R9  R10 R11 R12 R13 R14 R15          │           │         │
│  │    │                                 │           │           │         │
│  │    │   Pairs: P0 P1 P2 P3 P4 P5 P6 P7│          │           │         │
│  │    │         (8-bit addressing)      │           │           │         │
│  │    └────────────┬───────────────────┘           │           │         │
│  │                 │                                │           │         │
│  └─────────────────┼────────────────────────────────┘           │         │
│                    │                                             │         │
│                    │ reg_rdata[3:0]                  alu_result  │         │
│                    │                                   [3:0]     │         │
│                    │                                             │         │
│                    ▼                                             ▼         │
│  ┌─────────────────────────────────────────────────────────────────┐      │
│  │                    MEMORY INTERFACE                             │      │
│  │                                                                  │      │
│  │  ┌──────────────────────────┐    ┌──────────────────────────┐  │      │
│  │  │  RAM Address Register    │    │   RAM Data (4-bit)       │  │      │
│  │  │      (12-bit)            │    │                          │  │      │
│  │  │  Set by SRC instruction  │    │   1280 x 4-bit words    │  │      │
│  │  └──────────┬───────────────┘    └──────────┬───────────────┘  │      │
│  │             │                                │                  │      │
│  │             │ ram_addr[11:0]                 │ ram_data[3:0]    │      │
│  │             ▼                                ▼                  │      │
│  └─────────────────────────────────────────────────────────────────┘      │
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐      │
│  │                    I/O INTERFACE                                │      │
│  │                                                                  │      │
│  │  ROM Ports (4-bit)               RAM Ports (4-bit)              │      │
│  │  ┌──────┐  ┌──────┐              ┌──────┐  ┌──────┐            │      │
│  │  │ IN   │  │ OUT  │              │ IN   │  │ OUT  │            │      │
│  │  └───┬──┘  └───┬──┘              └───┬──┘  └───┬──┘            │      │
│  │      │         │                     │         │                │      │
│  └──────┼─────────┼─────────────────────┼─────────┼────────────────┘      │
│         │         │                     │         │                       │
└─────────┼─────────┼─────────────────────┼─────────┼───────────────────────┘
          │         │                     │         │
          ▼         ▼                     ▼         ▼
      External I/O Devices         External RAM Devices
```

## Signal Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                     INSTRUCTION CYCLE                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  State A1-A2: FETCH                                             │
│  ┌────────┐     ┌─────────┐     ┌──────────────────┐          │
│  │   PC   │────>│   ROM   │────>│ Instruction Reg  │          │
│  └────────┘     └─────────┘     └──────────────────┘          │
│      │                                                          │
│      │ PC++                                                     │
│      ▼                                                          │
│                                                                  │
│  State A3: DECODE                                               │
│  ┌──────────────────┐     ┌───────────────────────┐           │
│  │ Instruction Reg  │────>│ Instruction Decoder   │           │
│  └──────────────────┘     └───────────┬───────────┘           │
│                                        │                        │
│                                        │ Control Signals        │
│                                        ▼                        │
│                                                                  │
│  State M1-M2: EXECUTE (or fetch 2nd byte)                      │
│  ┌─────────┐     ┌─────────────┐     ┌──────────────┐         │
│  │ Reg/RAM │────>│     ALU     │────>│ Accumulator  │         │
│  └─────────┘     └─────────────┘     └──────────────┘         │
│                          │                                      │
│                          │ Carry                                │
│                          ▼                                      │
│                  ┌──────────────┐                              │
│                  │  Carry Flag  │                              │
│                  └──────────────┘                              │
│                                                                  │
│  State X1-X3: WRITEBACK                                         │
│  ┌──────────────┐     ┌─────────────┐                         │
│  │ Accumulator  │────>│ Register or │                         │
│  └──────────────┘     │   Memory    │                         │
│                       └─────────────┘                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Instruction Execution Timeline

```
Clock Cycle:  1    2    3    4    5    6    7    8
            ┌────┬────┬────┬────┬────┬────┬────┬────┐
State:      │ A1 │ A2 │ A3 │ M1 │ M2 │ X1 │ X2 │ X3 │
            └────┴────┴────┴────┴────┴────┴────┴────┘
               │    │    │    │    │    │    │    │
               │    │    │    │    │    │    │    │
Fetch:      ───┴────┴────                            
Decode:               ────┴────
Execute:                   ────┴────┴────┴────┴────
Writeback:                           ────┴────┴────
PC Inc:                                          ────>
```

## Register Organization

```
┌─────────────────────────────────────────────────────┐
│              REGISTER FILE                          │
├─────────────────────────────────────────────────────┤
│                                                      │
│  Individual Registers (4-bit each):                 │
│  ┌────┬────┬────┬────┬────┬────┬────┬────┐        │
│  │ R0 │ R1 │ R2 │ R3 │ R4 │ R5 │ R6 │ R7 │        │
│  └────┴────┴────┴────┴────┴────┴────┴────┘        │
│  ┌────┬────┬────┬────┬────┬────┬────┬────┐        │
│  │ R8 │ R9 │R10 │R11 │R12 │R13 │R14 │R15 │        │
│  └────┴────┴────┴────┴────┴────┴────┴────┘        │
│                                                      │
│  Register Pairs (8-bit):                            │
│  ┌─────────┬─────────┬─────────┬─────────┐        │
│  │ P0(0,1) │ P1(2,3) │ P2(4,5) │ P3(6,7) │        │
│  └─────────┴─────────┴─────────┴─────────┘        │
│  ┌─────────┬─────────┬─────────┬─────────┐        │
│  │ P4(8,9) │P5(10,11)│P6(12,13)│P7(14,15)│        │
│  └─────────┴─────────┴─────────┴─────────┘        │
│                                                      │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│              ACCUMULATOR & CARRY                     │
├─────────────────────────────────────────────────────┤
│                                                      │
│         ┌───────────────┐    ┌─────┐               │
│         │  Accumulator  │    │ CY  │               │
│         │    (4-bit)    │    │(1b) │               │
│         └───────────────┘    └─────┘               │
│                                                      │
└─────────────────────────────────────────────────────┘
```

## Memory Map

```
PROGRAM MEMORY (ROM) - 4KB
┌────────────┬──────────────────────────────┐
│  Address   │       Content                │
├────────────┼──────────────────────────────┤
│ 0x000-0x0FF│ Page 0  (256 bytes)          │
│ 0x100-0x1FF│ Page 1  (256 bytes)          │
│ 0x200-0x2FF│ Page 2  (256 bytes)          │
│     ...    │        ...                   │
│ 0xF00-0xFFF│ Page 15 (256 bytes)          │
└────────────┴──────────────────────────────┘

DATA MEMORY (RAM) - 1280 x 4-bit
┌────────────┬──────────────────────────────┐
│ Addressing │       Organization           │
├────────────┼──────────────────────────────┤
│ 12-bit addr│ 1280 x 4-bit words          │
│            │ = 320 characters (8-bit)     │
│            │ = 40 registers (16x4-bit)    │
│            │                              │
│ Per chip:  │ Main character (4-bit)       │
│            │ Status char 0-3 (4-bit each) │
└────────────┴──────────────────────────────┘
```

## Pin Distribution

```
                    North (ROM Interface)
         rom_addr[11:0], rom_data[7:0], rom_ce
         ┌──────────────────────────────────┐
         │                                  │
         │                                  │
West     │                                  │  East
(Clock   │        MIYAMII-4000              │  (I/O Ports)
Reset    │                                  │  rom_port[3:0]
Control) │                                  │  ram_port[3:0]
         │                                  │  test_pin
         │                                  │  status outputs
         └──────────────────────────────────┘
         ram_addr[11:0], ram_data[3:0], ram_we, ram_ce
                    South (RAM Interface)
```

## Data Flow Example (ADD instruction)

```
1. Fetch Instruction (A1-A2)
   PC ──> ROM ──> IR
         (0x81 = ADD R1)

2. Decode (A3)
   IR ──> Decoder ──> Control Signals
          opcode=1000, reg=0001

3. Execute (M1-M2)
   ┌────────────┐
   │ ACC = 5    │──┐
   │ R1  = 3    │  │
   └────────────┘  │
                   ▼
              ┌─────────┐
              │   ALU   │
              │  5 + 3  │
              └────┬────┘
                   │
                   ▼ 8

4. Writeback (X1-X3)
   ALU Result ──> ACC
   8 ──> Accumulator
   Carry ──> Carry Flag
```

## Clock Phases

```
Clock Cycle (10.8 μs):

clk:     ┌───┐   ┌───┐   ┌───┐   ┌───┐
         │   │   │   │   │   │   │   │
       ──┘   └───┘   └───┘   └───┘   └──

phi1:    ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐
         │ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │
       ──┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └──

phi2:     ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐
          │ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │
       ───┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─

State:   A1  A2  A3  M1  M2  X1  X2  X3
```

---

*This diagram shows the complete architecture of the Miyamii-4000 processor with all major components and their interconnections.*
